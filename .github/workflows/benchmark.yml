# GitHub Actions Workflow for SSG Benchmark
# Runs automated benchmarks on schedule and manual trigger

name: SSG Benchmark

on:
  # Run weekly on Sunday at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      ssgs:
        description: 'SSGs to benchmark (space-separated)'
        required: false
        default: 'hugo zola jekyll'
      page_counts:
        description: 'Page counts to test (space-separated)'
        required: false
        default: '10 100 1000'
      iterations:
        description: 'Number of iterations per test'
        required: false
        default: '3'

  # Run on push to main for testing workflow changes
  push:
    branches:
      - main
    paths:
      - '.github/workflows/benchmark.yml'
      - 'scripts/**'
      - 'docker/**'

env:
  DEFAULT_SSGS: 'hugo zola jekyll'
  DEFAULT_PAGE_COUNTS: '10 100 1000'
  DEFAULT_ITERATIONS: '3'

jobs:
  benchmark:
    name: Run SSG Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Build Docker images
        run: |
          SSGS="${{ github.event.inputs.ssgs || env.DEFAULT_SSGS }}"
          for ssg in $SSGS; do
            if [ -f "docker/Dockerfile.${ssg}" ]; then
              echo "Building image for ${ssg}..."
              docker build -t ssg-benchmark-${ssg} -f docker/Dockerfile.${ssg} . || echo "Failed to build ${ssg}, skipping..."
            fi
          done

      - name: Run Benchmark
        run: |
          export SSGS="${{ github.event.inputs.ssgs || env.DEFAULT_SSGS }}"
          export PAGE_COUNTS="${{ github.event.inputs.page_counts || env.DEFAULT_PAGE_COUNTS }}"
          export ITERATIONS="${{ github.event.inputs.iterations || env.DEFAULT_ITERATIONS }}"
          export USE_DOCKER=true
          export VERBOSE=true

          ./scripts/benchmark.sh

      - name: Generate Reports
        run: |
          chmod +x scripts/report.sh

          # Find latest results
          LATEST=$(ls -t results/ | grep -v ".gitkeep" | head -1)
          RESULTS_DIR="results/${LATEST}"

          if [ -d "$RESULTS_DIR" ]; then
            # Generate different report formats
            ./scripts/report.sh -r "$RESULTS_DIR" -f markdown > "${RESULTS_DIR}/report.md"
            ./scripts/report.sh -r "$RESULTS_DIR" -f json > "${RESULTS_DIR}/report.json"
            ./scripts/report.sh -r "$RESULTS_DIR" -f html > "${RESULTS_DIR}/report.html"

            echo "Reports generated in ${RESULTS_DIR}"
          fi

      - name: Upload Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: results/
          retention-days: 90

      - name: Create Results Summary
        run: |
          LATEST=$(ls -t results/ | grep -v ".gitkeep" | head -1)

          if [ -f "results/${LATEST}/summary.md" ]; then
            echo "## ðŸš€ SSG Benchmark Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
            echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "results/${LATEST}/summary.md" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit Results (optional)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          LATEST=$(ls -t results/ | grep -v ".gitkeep" | head -1)

          if [ -n "$LATEST" ]; then
            git add "results/${LATEST}/"
            git commit -m "chore: add benchmark results ${LATEST}" || echo "No changes to commit"
            git push || echo "Failed to push (might need write permissions)"
          fi

  compare:
    name: Compare with Previous Results
    runs-on: ubuntu-latest
    needs: benchmark
    if: always() && needs.benchmark.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Current Results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results-${{ github.run_number }}
          path: results/

      - name: Compare Results
        run: |
          echo "## ðŸ“Š Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get the two most recent result directories
          RESULTS=($(ls -t results/ | grep -v ".gitkeep" | head -2))

          if [ ${#RESULTS[@]} -ge 2 ]; then
            CURRENT="${RESULTS[0]}"
            PREVIOUS="${RESULTS[1]}"

            echo "Comparing **${CURRENT}** with **${PREVIOUS}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Simple comparison of build times
            echo "| SSG | Previous (ms) | Current (ms) | Change |" >> $GITHUB_STEP_SUMMARY
            echo "|-----|---------------|--------------|--------|" >> $GITHUB_STEP_SUMMARY

            for ssg in hugo zola jekyll blades hwaro; do
              PREV_TIME=$(grep "^${ssg}," "results/${PREVIOUS}/results.csv" 2>/dev/null | head -1 | cut -d',' -f4 || echo "N/A")
              CURR_TIME=$(grep "^${ssg}," "results/${CURRENT}/results.csv" 2>/dev/null | head -1 | cut -d',' -f4 || echo "N/A")

              if [ "$PREV_TIME" != "N/A" ] && [ "$CURR_TIME" != "N/A" ]; then
                DIFF=$((CURR_TIME - PREV_TIME))
                if [ $DIFF -gt 0 ]; then
                  CHANGE="â¬†ï¸ +${DIFF}"
                elif [ $DIFF -lt 0 ]; then
                  CHANGE="â¬‡ï¸ ${DIFF}"
                else
                  CHANGE="âž¡ï¸ 0"
                fi
                echo "| ${ssg} | ${PREV_TIME} | ${CURR_TIME} | ${CHANGE} |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "Not enough historical data for comparison." >> $GITHUB_STEP_SUMMARY
          fi
